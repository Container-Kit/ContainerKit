# Build Files Copy Script Documentation

This script automates copying of Container Kit build artifacts from Tauri build output to structured release directories. This script is responsible for organizing, copying, and packaging Tauri build outputs into a structured release directory with proper manifests and documentation.

## Overview

This TypeScript script takes build artifacts generated by `tauri build` and creates a complete release bundle ready for deployment and distribution.

## Usage

### Command Line Interface

```bash
# Basic usage with defaults
tsx scripts/copy-build-files-to-release.ts

# With custom domain
tsx scripts/copy-build-files-to-release.ts -d https://container-kit.ethercorps.io/release

# Override version
tsx scripts/copy-build-files-to-release.ts -v 1.0.0

# Force overwrite existing bundle
tsx scripts/copy-build-files-to-release.ts -f

# Show help
tsx scripts/copy-build-files-to-release.ts -h
```

### npm Scripts

```bash
# Create bundle with defaults
pnpm bundle:create

# Force overwrite
pnpm bundle:create:force

# Custom domain
pnpm bundle:create:custom https://your-domain.com

# Show help
pnpm bundle:help
```

## Command Line Options

| Option      | Short | Description                     | Default                                       | Example                       |
| ----------- | ----- | ------------------------------- | --------------------------------------------- | ----------------------------- |
| `--domain`  | `-d`  | Domain for update URLs          | `https://container-kit.ethercorps.io/release` | `-d https://releases.app.com` |
| `--version` | `-v`  | Override version                | Read from `tauri.conf.json`                   | `-v 1.2.0`                    |
| `--force`   | `-f`  | Force overwrite existing bundle | `false`                                       | `-f`                          |
| `--help`    | `-h`  | Show help message               | N/A                                           | `-h`                          |

## Prerequisites

### Required Files

1. **Build Artifacts** (from `tauri build`):

    - `src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/Container Kit_{version}_aarch64.dmg`
    - `src-tauri/target/aarch64-apple-darwin/release/bundle/macos/Container Kit.app.tar.gz`
    - `src-tauri/target/aarch64-apple-darwin/release/bundle/macos/Container Kit.app.tar.gz.sig`
    - `src-tauri/target/aarch64-apple-darwin/release/bundle/macos/Container Kit.app/`

2. **Configuration Files**:
    - `src-tauri/tauri.conf.json` (for version and public key)
    - `package.json` (project validation)

### Environment

- Node.js 18+
- tsx (TypeScript execution)
- Completed Tauri build artifacts

## Script Workflow

### 1. Argument Parsing

- Processes command line arguments
- Sets default values from configuration
- Validates options and shows help if requested

### 2. Version Detection

- Reads version from `src-tauri/tauri.conf.json`
- Allows version override via command line
- Validates version format and availability

### 3. Artifact Validation

- Checks for existence of all required build artifacts
- Validates file accessibility and integrity
- Reports missing files with helpful error messages

### 4. Directory Structure Creation

- Creates `release/{version}/macos/` directory structure
- Handles existing directories (with force option)
- Sets up proper permissions and access

### 5. Artifact Copying

- Copies DMG installer file
- Copies compressed app bundle and signature
- Recursively copies uncompressed app directory
- Preserves file permissions and metadata

### 6. Manifest Generation

- Creates `update.json` with Tauri updater format
- Includes cryptographic signature from build
- Generates download URLs with proper encoding
- Sets publication timestamp and release notes

### 7. Index Management

- Updates or creates master `index.json`
- Tracks all versions and metadata
- Includes download statistics and changelog
- Maintains updater endpoint configuration

### 8. Documentation Generation

- Creates comprehensive `README.md`
- Includes usage instructions and deployment guide
- Documents directory structure and file purposes
- Provides configuration examples

### 9. Validation

- Validates all created JSON files
- Checks file existence and accessibility
- Verifies directory structure completeness
- Reports any issues or inconsistencies

### 10. Summary Report

- Shows created files and their sizes
- Provides deployment URLs and next steps
- Lists configuration requirements
- Offers verification commands

## Generated Files

### Release Structure

```
release/
├── README.md                           # Auto-generated documentation
├── index.json                          # Master version index
└── {version}/                          # Version-specific directory
    ├── update.json                     # Tauri updater manifest
    └── macos/                          # macOS artifacts
        ├── Container Kit.app.tar.gz    # Compressed app for updates
        ├── Container Kit.app.tar.gz.sig # Cryptographic signature
        ├── Container Kit.app/          # Uncompressed app directory
        └── Container Kit_{version}_aarch64.dmg # DMG installer
```

### update.json Format

```json
{
    "version": "0.2.0",
    "notes": "Release notes with changelog...",
    "pub_date": "2025-01-21T18:30:00.000Z",
    "platforms": {
        "darwin-aarch64": {
            "signature": "base64-encoded-signature",
            "url": "https://domain.com/release/0.2.0/macos/Container%20Kit.app.tar.gz"
        }
    }
}
```

### index.json Format

```json
{
    "name": "Container Kit",
    "description": "GUI for apple container CLI",
    "latest_version": "0.2.0",
    "versions": {
        "0.2.0": {
            "release_date": "2025-01-21T18:30:00.000Z",
            "manifest_url": "./0.2.0/update.json",
            "downloads": {
                "dmg": "./0.2.0/macos/Container%20Kit_0.2.0_aarch64.dmg",
                "app_bundle": "./0.2.0/macos/Container%20Kit.app.tar.gz",
                "app_directory": "./0.2.0/macos/Container%20Kit.app"
            },
            "platforms": ["darwin-aarch64"],
            "file_size": 7821591,
            "changelog": ["Feature 1", "Feature 2", "Bug fixes"]
        }
    },
    "updater": {
        "endpoint": "https://domain.com/release/{version}/update.json",
        "public_key": "minisign-public-key"
    },
    "metadata": {
        "created": "2025-01-21T18:30:00.000Z",
        "last_updated": "2025-01-21T18:30:00.000Z",
        "bundle_format_version": "1.0"
    }
}
```

## Configuration

### Default Domain

The script uses `https://container-kit.ethercorps.io/release` as the default domain. Override with the `-d` option.

### File Paths

All paths are relative to the project root directory. The script automatically detects the project structure.

### Version Source

Version is read from `src-tauri/tauri.conf.json` unless overridden with the `-v` option.

## Error Handling

### Common Errors

#### Build Artifacts Not Found

```
❌ DMG file not found: /path/to/dmg/file
ℹ️  Please run "tauri build" first
```

**Solution**: Run `tauri build` to generate required artifacts.

#### Version Already Exists

```
❌ Bundle for version 0.2.0 already exists
ℹ️  Use -f/--force to overwrite, or increment the version
```

**Solutions**:

- Use `--force` flag to overwrite
- Increment version in `tauri.conf.json`

#### Invalid JSON Configuration

```
❌ Error reading tauri.conf.json: Unexpected token
```

**Solution**: Validate and fix `tauri.conf.json` syntax.

#### Permission Errors

```
❌ Missing required file: /path/to/file
```

**Solution**: Ensure proper file permissions and build completion.

## TypeScript Interface Definitions

### Core Types

```typescript
interface Config {
    domain: string;
    projectRoot: string;
    tauriConf: string;
    bundleDir: string;
    packageJson: string;
}

interface Options {
    domain: string;
    version?: string;
    force: boolean;
}

interface BuildArtifacts {
    dmg: string;
    appBundle: string;
    signature: string;
    appDir: string;
}

interface UpdateManifest {
    version: string;
    notes: string;
    pub_date: string;
    platforms: {
        'darwin-aarch64': {
            signature: string;
            url: string;
        };
    };
}
```

## Integration with release.ts

The `copy-build-files-to-release.ts` script is designed to work standalone or as part of the complete release workflow via `release.ts`. When used with `release.ts`, the build steps are handled automatically before copying build files to release.

## Best Practices

### Before Running

1. Ensure all dependencies are installed (`pnpm install`)
2. Complete a successful Tauri build (`tauri build`)
3. Verify signing keys are properly configured
4. Test the app functionality before bundling

### After Running

1. Review generated files and structure
2. Test download URLs (if deployed)
3. Verify JSON manifest validity
4. Test updater functionality with the generated manifest

### Version Management

- Follow semantic versioning (e.g., 1.0.0, 1.0.1, 1.1.0)
- Update version in `tauri.conf.json` before bundling
- Use meaningful release notes in generated manifests
- Tag releases in version control

## Security Considerations

### Cryptographic Signatures

- Never modify `.sig` files manually
- Verify signatures match the built artifacts
- Store private keys securely (not in version control)
- Rotate signing keys periodically

### URL Security

- Always use HTTPS for release domains
- Validate domain ownership before deployment
- Use proper CORS headers for Tauri apps
- Monitor download access logs

## Performance Optimization

### Large Files

- The script handles large DMG files efficiently
- Uses streaming for file operations where possible
- Provides progress feedback for long operations

### Network Considerations

- URLs are properly encoded for web compatibility
- File paths are optimized for CDN distribution
- Manifests are kept lightweight for fast updates

## Troubleshooting

### Debug Mode

Add debug logging by setting environment variable:

```bash
DEBUG=1 tsx scripts/copy-build-files-to-release.ts
```

### Manual Verification

```bash
# Check generated structure
find release/ -type f -name "*.json" | xargs cat | jq .

# Verify file sizes
du -h release/*/macos/*

# Test JSON validity
jq empty release/*/update.json
jq empty release/index.json
```

### Recovery

If the script fails partway through:

1. Check error messages for specific issues
2. Fix underlying problems (permissions, disk space, etc.)
3. Use `--force` flag to overwrite partial results
4. Verify artifact integrity before retrying

## Contributing

When modifying this script:

1. Maintain TypeScript type safety
2. Update documentation for any new options
3. Add appropriate error handling
4. Test with various version scenarios
5. Verify backward compatibility with existing releases

## Related Files

- `scripts/release.ts` - Complete release workflow
- `docs/RELEASE_SCRIPT.md` - Release script documentation
- `docs/RELEASE.md` - Complete release process guide
- `docs/QUICK_REFERENCE.md` - Command quick reference
